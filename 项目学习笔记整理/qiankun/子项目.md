### app.tsx

```ts
import type {
  Settings as LayoutSettings,
  BasicLayoutProps,
} from "@ant-design/pro-layout";
import { message, notification } from "antd";
import { PageLoading } from "@ant-design/pro-layout";
import type { RequestConfig } from "umi";
import { history } from "umi";
import type { RequestOptionsInit, ResponseError } from "umi-request";
import { Footer } from "bdw-components";
import RightContent from "@/components/RightContent";
import { PageEnum } from "@/constants/enum";
import { getUserInfo, getRouter } from "./services/api";
import defaultSettings from "../config/defaultSettings";

const isQianKun = window.__POWERED_BY_QIANKUN__;

/** 获取用户信息比较慢的时候会展示一个 loading */
export const initialStateConfig = {
  loading: <PageLoading />,
};

/**
 * @see  https://umijs.org/zh-CN/plugins/plugin-initial-state
 * */
export async function getInitialState(): Promise<{
  roles?: string[];
  permissions?: string[];
  currentUser?: User.CurrentUser;
  settings?: Partial<LayoutSettings>;
  fetchUserInfo?: () => Promise<any>;
}> {
  const fetchUserInfo = async () => {
    try {
      let res: any;
      try {
        res = await getUserInfo();
      } catch (e) {
        console.error(e);
      }

      return {
        currentUser: res.user,
        permissions: res.permissions,
        roles: res.roles,
      };
    } catch (error) {
      history.push(PageEnum.BASE_LOGIN);
    }
    return undefined;
  };

  // 如果是登录页面，不执行
  if (history.location.pathname !== PageEnum.BASE_LOGIN) {
    const data = await fetchUserInfo();
    const { currentUser, permissions, roles } = data || {};

    return {
      roles,
      permissions,
      currentUser,
      fetchUserInfo,
      settings: defaultSettings,
    };
  }

  return {
    fetchUserInfo,
    settings: defaultSettings,
  };
}

// https://umijs.org/zh-CN/plugins/plugin-layout
export const layout = ({
  initialState,
}: {
  initialState: {
    settings?: Partial<LayoutSettings>;
    currentUser?: User.CurrentUser;
  };
}): BasicLayoutProps => {
  return {
    pure: isQianKun,
    // splitMenus: true,
    rightContentRender: () => <RightContent />,
    disableContentMargin: false,
    waterMarkProps: {
      content: initialState?.currentUser?.nickName,
    },
    onPageChange: () => {
      const { location } = history;

      // 如果没有登录，重定向到 login
      if (
        !initialState?.currentUser &&
        location.pathname !== PageEnum.BASE_LOGIN
      ) {
        history.push(PageEnum.BASE_LOGIN);
      }
    },
    menuHeaderRender: undefined,
    footerRender: () => <Footer />,
    // 自定义 403 页面
    // unAccessible: <div>unAccessible</div>,
    ...initialState?.settings,
  };
};

const groupPrefix = "/group";
const removeGroupPrefix = (list: any[] = []) => {
  list.forEach((item: any) => {
    item.path = item.path.slice(groupPrefix.length);
    if (item.children) removeGroupPrefix(item.children);
  });
};

let authRoutes: any[] = [];
export function render(oldRender: any) {
  if (window.location.pathname !== PageEnum.BASE_LOGIN) {
    getRouter().then((res) => {
      if (res) {
        const data = res.data || [];
        authRoutes = data.reduce((prev: any, curr: any) => {
          if (curr.path === "/group") {
            removeGroupPrefix(curr.children);
            prev = prev.concat(curr.children || []);
          } else {
            prev.push(curr);
          }
          return prev;
        }, []);

        authRoutes = authRoutes.find(
          (item: any) => item.path === "/marketing"
        )?.children;
        console.log("authRoutes", authRoutes);
      } else {
        history.push(PageEnum.BASE_LOGIN);
      }
      oldRender();
    });
  } else {
    oldRender();
  }
}

const prefixLen = "/marketing".length;
const generateRoutes = (
  routesMap: Recordable,
  authRoutes: any[] = [],
  depth = 0
) => {
  const arr: any[] = [];
  authRoutes.forEach((item) => {
    const {
      meta,
      children,
      redirect,
      components,
      hidden = false,
      path: originPath,
    } = item;
    const { title, icon } = meta || {};
    const path = originPath ? originPath.slice(prefixLen) : originPath;

    if (components) {
      arr.push({ components });
      return;
    }
    if (redirect && redirect !== "noRedirect") {
      arr.push({ path, redirect });
      return;
    }

    const obj: Recordable = {
      name: title,
      icon: "crown" || icon,
      path,
      hideInMenu: hidden,
    };
    if (routesMap[path]) {
      obj.component = routesMap[path]?.component;
      if (!obj.component) delete obj.component;
    }

    if (children) {
      const tempChildren = [...children];
      const [firstChild] = tempChildren.filter((item) => !item.hidden);
      children.push({
        path: originPath,
        redirect: firstChild?.path.slice(prefixLen),
      });
      children.push({ components: "./404" });
      obj.routes = generateRoutes(routesMap, children, depth++);
    }

    arr.push(obj);
  });

  return arr;
};

console.log("qiankun", isQianKun);
const extract = (list: any[], routesMap: Recordable) => {
  list.forEach((item) => {
    const { icon, name, path, routes, ...others } = item;
    if (routes && routes.length) extract(routes, routesMap);
    if (path) routesMap[path] = { icon, path, name, ...others };
  });
};

export function patchRoutes({ routes }: any) {
  const { isBackMenu } = defaultSettings;
  if (isBackMenu) {
    const sliceLen = process.env.NODE_ENV === "development" ? 4 : 1;
    const baseRoutes = routes[0].routes.slice(0, sliceLen);
    const extraRoutes = routes[0].routes.slice(sliceLen, -2);
    const endRoutes = routes[0].routes.slice(-2);

    const routesMap: Recordable = {};
    extract(extraRoutes, routesMap);

    routes[0].routes = baseRoutes
      .concat(generateRoutes(routesMap, authRoutes))
      .concat(endRoutes);
  }
}

export const qiankun = {
  // 应用加载之前
  async bootstrap(props: Recordable) {
    console.log("system bootstrap", props);
  },
  // 应用 render 之前触发
  async mount(props: Recordable) {
    console.log("system mount", props);
  },
  // 应用卸载之后触发
  async unmount(props: Recordable) {
    console.log("system unmount", props);
  },
};

const codeMessage = {
  200: "服务器成功返回请求的数据。",
  201: "新建或修改数据成功。",
  202: "一个请求已经进入后台排队（异步任务）。",
  204: "删除数据成功。",
  400: "发出的请求有错误，服务器没有进行新建或修改数据的操作。",
  401: "用户没有权限（令牌、用户名、密码错误）。",
  403: "用户得到授权，但是访问是被禁止的。",
  404: "发出的请求针对的是不存在的记录，服务器没有进行操作。",
  405: "请求方法不被允许。",
  406: "请求的格式不可得。",
  410: "请求的资源被永久删除，且不会再得到的。",
  422: "当创建一个对象时，发生一个验证错误。",
  500: "服务器发生错误，请检查服务器。",
  502: "网关错误。",
  503: "服务不可用，服务器暂时过载或维护。",
  504: "网关超时。",
};

/** 异常处理程序
 * @see https://beta-pro.ant.design/docs/request-cn
 */
const errorHandler = (error: ResponseError) => {
  const { response } = error;
  if (response && response.status) {
    const errorText = codeMessage[response.status] || response.statusText;
    const { status, url } = response;

    notification.error({
      message: `请求错误 ${status}: ${url}`,
      description: errorText,
    });
  }

  if (!response) {
    notification.error({
      description: "您的网络发生异常，无法连接服务器",
      message: "网络异常",
    });
  }

  throw response;
};

// request拦截器, 处理token
const tokenInterceptor = (url: string, options: RequestOptionsInit) => {
  const { headers: optionsHeaders, ...otherOptions } = options;

  const headers: any = {
    "Content-Type": "application/json;charset=utf-8",
    ...optionsHeaders,
  };

  // step1: auth 处理
  const accessToken = localStorage.getItem("access_token");
  if (accessToken) headers.Authorization = accessToken;

  if (url.startsWith("/mock")) {
    url = `https://mockapi.eolinker.com/IMGnHVIb11310282d113f38f7d59566e0d4265e990e572e${url}`;
  } else {
    url = `/api${url}`;
  }

  return {
    url,
    options: {
      ...otherOptions,
      headers,
    },
  };
};

// request拦截器, 处理 401
const resInterceptor = async (
  response: Response,
  options: RequestOptionsInit
) => {
  if (options.responseType === "blob") {
    return response;
  }

  const data = await response.clone().json();
  switch (data.code) {
    case 401:
    case 403:
      notification.warning({
        message: "登录信息过期,请重新登陆!",
        duration: 3,
      });
      localStorage.clear();
      if (isQianKun) {
        window.location.href = PageEnum.BASE_LOGIN;
      } else {
        history.replace(PageEnum.BASE_LOGIN);
      }
      break;
    case 1:
      data.code = 200;
      break;
    case 0:
    case 500:
      message.error(data.msg || "服务器错误！");
      break;
    default:
  }

  // return response;
  return data;
};

// https://umijs.org/zh-CN/plugins/plugin-request
export const request: RequestConfig = {
  errorHandler,
  timeout: 20000,
  requestInterceptors: [tokenInterceptor],
  responseInterceptors: [resInterceptor],
};
```

### routes.ts

```ts
export default [
  {
    path: "/sys",
    layout: false,
    routes: [
      {
        path: "/sys",
        routes: [
          { name: "登录", path: "/sys/login", component: "./user/Login" },
        ],
      },
    ],
  },
  {
    path: "/coupon",
    name: "优惠券管理",
    icon: "crown",
    routes: [
      {
        path: "coupon-list",
        name: "优惠券列表",
        exact: true,
        component: "./coupon/CouponList",
      },
      {
        path: "coupon-distribution-detail",
        name: "优惠券发放明细",
        exact: true,
        hidden: true,
        component: "./coupon/CouponDistributionDetail",
      },
      {
        components: "./404",
      },
    ],
  },
  {
    path: "/activity",
    name: "活动管理",
    icon: "crown",
    routes: [
      {
        path: "activity-list",
        name: "活动列表",
        exact: true,
        component: "./activity/ActivityList",
      },
      {
        path: "activity-display",
        name: "活动展示",
        routes: [
          {
            path: "app",
            name: "App",
            exact: true,
            component: "./activity/ActivityDisplay/App",
          },
          {
            path: "mini",
            name: "小程序",
            exact: true,
            component: "./activity/ActivityDisplay/MiniProgram",
          },
        ],
      },
    ],
  },
  {
    path: "/",
    redirect: "/coupon",
  },
  {
    components: "./404",
  },
];
```

### proxy.ts

```ts
/**
 * 在生产环境 代理是无法生效的，所以这里没有生产环境的配置
 * The agent cannot take effect in the production environment
 * so there is no configuration of the production environment
 * For details, please see
 * https://pro.ant.design/docs/deploy
 */
const proxyTarget = "https://testapi.betterwood.com";
const mockTarget =
  "https://mockapi.eolinker.com/IMGnHVIb11310282d113f38f7d59566e0d4265e990e572e";

export default {
  dev: {
    "/api/": {
      target: proxyTarget,
      changeOrigin: true,
      pathRewrite: { "^/api": "" },
    },
    "/mock/": {
      target: mockTarget,
      changeOrigin: true,
      pathRewrite: { "^": "" },
    },
  },
  test: {
    "/api/": {
      target: proxyTarget,
      changeOrigin: true,
      pathRewrite: { "^": "" },
    },
  },
  uat: {
    "/api/": {
      target: proxyTarget,
      changeOrigin: true,
      pathRewrite: { "^": "" },
    },
  },
};
```
