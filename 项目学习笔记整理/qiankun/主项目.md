### app.tsx

```tsx
import { useState } from "react";
import type {
  MenuDataItem,
  Settings as LayoutSettings,
} from "@ant-design/pro-layout";
import { message, notification } from "antd";
import { PageLoading } from "@ant-design/pro-layout";
import { MicroApp, RequestConfig, RunTimeLayoutConfig } from "umi";
import { history } from "umi";
import type { RequestOptionsInit, ResponseError } from "umi-request";
import { Footer } from "bdw-components";
import TagView from "@/components/TagView";
import RightContent from "@/components/RightContent";
import { PageEnum } from "@/constants/enum";
import { outLogin } from "./services/api";
import { getRouter, getUserInfo } from "./services/system";
import defaultSettings from "../config/defaultSettings";
import DynamicIcon from "./components/DynamicIcon";

message.config({ maxCount: 1 });

/** 获取用户信息比较慢的时候会展示一个 loading */
export const initialStateConfig = {
  loading: <PageLoading />,
};

export const useQiankunStateForSlave = () => {
  const [globalState, setQiankunGlobalState] = useState<{
    slogan: string;
    userName?: string;
    access_token?: string;
    currentUser?: User.CurrentUser;
    outLogin: () => void;
  }>({
    slogan: "Hello MicroFrontend",
    outLogin,
  });

  return {
    globalState,
    setQiankunGlobalState,
  };
};

/**
 * @see  https://umijs.org/zh-CN/plugins/plugin-initial-state
 * */
export async function getInitialState(): Promise<{
  roles?: string[];
  permissions?: string[];
  currentUser?: User.CurrentUser;
  settings?: Partial<LayoutSettings>;
  fetchUserInfo?: () => Promise<SysAPI.UserInfo | undefined>;
}> {
  const fetchUserInfo = async () => {
    try {
      return await getUserInfo();
    } catch (error) {
      console.error(error);
      history.push(PageEnum.BASE_LOGIN);
    }
    return undefined;
  };

  // 如果是登录页面，不执行
  if (history.location.pathname !== PageEnum.BASE_LOGIN) {
    const data = await fetchUserInfo();
    const { user, permissions, roles } = data || {};

    return {
      roles,
      permissions,
      currentUser: user,
      fetchUserInfo,
      settings: defaultSettings,
    };
  }

  return {
    fetchUserInfo,
    settings: defaultSettings,
  };
}

const loopMenuItem = (menus: MenuDataItem[]): MenuDataItem[] => {
  return menus.map(({ icon, routes, ...item }) => ({
    ...item,
    icon: typeof icon === "string" ? <DynamicIcon value={icon} /> : icon,
    routes: routes ? loopMenuItem(routes) : [],
  }));
};

// https://umijs.org/zh-CN/plugins/plugin-layout
const hasTab = false;
export const layout: RunTimeLayoutConfig = ({ initialState }) => {
  const { location } = history;

  return {
    menu: {
      locale: false,
      request: async (_, defaultMenu) => loopMenuItem(defaultMenu),
    },
    splitMenus: true,
    rightContentRender: () => <RightContent />,
    disableContentMargin: false,
    waterMarkProps: {
      content: initialState?.currentUser?.nickName,
    },
    onPageChange: () => {
      const { location } = history;

      // 如果没有登录，重定向到 login
      if (
        !initialState?.currentUser &&
        location.pathname !== PageEnum.BASE_LOGIN
      ) {
        history.push(PageEnum.BASE_LOGIN);
      }
    },
    menuHeaderRender: undefined,
    contentStyle: {
      paddingTop: hasTab ? "40px" : 0,
    },
    childrenRender: (children) => {
      return hasTab ? (
        <>
          {initialState?.currentUser &&
          location.pathname !== PageEnum.BASE_LOGIN ? (
            <TagView children={children} home={PageEnum.BASE_HOME} />
          ) : (
            children
          )}
        </>
      ) : (
        children
      );
    },
    footerRender: () => <Footer />,
    // 自定义 403 页面
    // unAccessible: <div>unAccessible</div>,
    ...initialState?.settings,
  };
};

const getEntry = (
  type: "jbkill" | "member" | "rest" | "marketing" | "openplatform",
  port: number
) => {
  const { REACT_APP_ENV } = process.env;

  let entry = "";
  switch (REACT_APP_ENV) {
    case "dev":
      entry = `https://dev-${type}.betterwood.com`;
      break;
    case "test":
      entry = `https://test-${type}.betterwood.com`;
      break;
    case "pre":
      entry = `https://uat-${type}.betterwood.com`;
      break;
    case "prod":
      entry = `https://prod-${type}.betterwood.com`;
      break;
    default:
      entry = `//localhost:${port}`;
  }

  console.log("APP_ENV===>", REACT_APP_ENV, process.env);
  return entry;
};

const allMicroMap = {
  "story-kill": {
    name: "story-kill",
    entry:
      process.env.NODE_ENV === "production"
        ? getEntry("jbkill", 9091)
        : "//localhost:9001",
  },
  member: {
    name: "member",
    entry:
      process.env.NODE_ENV === "production"
        ? getEntry("member", 9092)
        : "//localhost:9002",
  },
  rest: {
    name: "rest",
    entry:
      process.env.NODE_ENV === "production"
        ? getEntry("rest", 9093)
        : "//localhost:9003",
  },
  marketing: {
    name: "marketing",
    entry:
      process.env.NODE_ENV === "production"
        ? getEntry("marketing", 9094)
        : "//localhost:9004",
  },
  platform: {
    name: "platform",
    entry:
      process.env.NODE_ENV === "production"
        ? getEntry("openplatform", 9095)
        : "//localhost:9005",
  },
};

export const qiankun = async () => {
  if (window.location.pathname !== PageEnum.BASE_LOGIN) {
    const apps: { name: string; entry: string }[] = [];
    const res = await getRouter();

    const routes = (res.data || []).reduce((prev, curr) => {
      if (curr.path === "/group") {
        removeGroupPrefix(curr.children);
        prev = prev.concat(curr.children || []);
      } else {
        prev.push(curr);
      }
      return prev;
    }, [] as SysAPI.RouterItem[]);

    routes.forEach((item) => {
      switch (item.path) {
        case "/member":
          apps.push(allMicroMap.member);
          break;
        case "/rest":
          apps.push(allMicroMap.rest);
          break;
        case "/story-kill":
          apps.push(allMicroMap["story-kill"]);
          break;
        case "/marketing":
          apps.push(allMicroMap.marketing);
          break;
        case "/platform":
          apps.push(allMicroMap.platform);
          break;
        default:
      }
    });

    console.log(apps);
    return Promise.resolve({
      apps,
      sandbox: true,
      prefetch: true,
    });
  }

  return Promise.resolve({ apps: [] });
};

const groupPrefix = "/group";
const removeGroupPrefix = (list: SysAPI.RouterItem[] = []) => {
  list.forEach((item) => {
    item.path = item.path.slice(groupPrefix.length);
    if (item.children) removeGroupPrefix(item.children);
  });
};

let authRoutes: any[] = [];
export function render(oldRender: any) {
  if (window.location.pathname !== PageEnum.BASE_LOGIN) {
    getRouter().then((res) => {
      if (res) {
        const data = res.data || [];
        authRoutes = data.reduce((prev: SysAPI.RouterItem[], curr) => {
          if (curr.path === "/group") {
            removeGroupPrefix(curr.children);
            prev = prev.concat(curr.children || []);
          } else {
            prev.push(curr);
          }
          return prev;
        }, []);
      } else {
        history.push(PageEnum.BASE_LOGIN);
      }
      oldRender();
    });
  } else {
    oldRender();
  }
}

const generateRoutes = (
  routesMap: Recordable,
  authRoutes: any[],
  depth = 0
) => {
  const arr: any[] = [];
  authRoutes.forEach((item) => {
    const { meta, path, children, redirect, components, hidden = false } = item;
    const { title, icon } = meta || {};

    if (components) {
      arr.push({ component: components });
      return;
    }
    if (redirect && redirect !== "noRedirect") {
      arr.push({ path, redirect });
      return;
    }

    const renderName = () => {
      switch (path) {
        case "/head/order":
          return (
            <span>
              {title}
              <span id="newOrderFlag" className="newOrderFlag">
                新订单
              </span>
            </span>
          );
        case "/head/room-service":
          return (
            <span>
              {title}
              <span id="roomService">0</span>
            </span>
          );
        default:
          return title;
      }
    };

    const obj: Recordable = {
      icon,
      path,
      name: renderName(),
      hideInMenu: hidden,
      exact: !redirect,
    };
    switch (path) {
      case "/story-kill":
      case "/rest":
      case "/member":
      case "/marketing":
      case "/platform":
        obj.exact = false;
        obj.component = () => <MicroApp name={path.slice(1)} base={path} />;

        if (children) {
          const [firstChild] = children;
          children.push({ path, redirect: firstChild.path });
          children.push({ components: "./404" });
          obj.routes = generateRoutes(routesMap, children, depth++);
        }
        break;
      default:
        if (routesMap[path]) {
          obj.component = routesMap[path]?.component;
          if (!obj.component) delete obj.component;
        }

        if (children) {
          const tempChildren = [...children];
          const [firstChild] = tempChildren.filter((item) => !item.hidden);
          children.push({ path, redirect: firstChild?.path });
          children.push({ components: "./404" });
          obj.routes = generateRoutes(routesMap, children, depth++);
        }
    }

    arr.push(obj);
  });

  return arr;
};

const extract = (list: any[], routesMap: Recordable) => {
  list.forEach((item) => {
    const { icon, name, path, routes, ...others } = item;
    if (routes && routes.length) extract(routes, routesMap);
    if (path) routesMap[path] = { icon, path, name, ...others };
  });
};

export function patchRoutes({ routes }: any) {
  const { isBackMenu } = defaultSettings;
  if (isBackMenu) {
    const sliceLen = process.env.NODE_ENV === "development" ? 5 : 2;
    const baseRoutes = routes[0].routes.slice(0, sliceLen);
    const extraRoutes = routes[0].routes.slice(sliceLen, -2);
    const endRoutes = routes[0].routes.slice(-2);

    const routesMap: Recordable = {};
    extract(extraRoutes, routesMap);

    routes[0].routes = baseRoutes
      .concat(generateRoutes(routesMap, authRoutes))
      .concat(endRoutes);
  }
}

const codeMessage = {
  200: "服务器成功返回请求的数据。",
  201: "新建或修改数据成功。",
  202: "一个请求已经进入后台排队（异步任务）。",
  204: "删除数据成功。",
  400: "发出的请求有错误，服务器没有进行新建或修改数据的操作。",
  401: "用户没有权限（令牌、用户名、密码错误）。",
  403: "用户得到授权，但是访问是被禁止的。",
  404: "发出的请求针对的是不存在的记录，服务器没有进行操作。",
  405: "请求方法不被允许。",
  406: "请求的格式不可得。",
  410: "请求的资源被永久删除，且不会再得到的。",
  422: "当创建一个对象时，发生一个验证错误。",
  500: "服务器发生错误，请检查服务器。",
  502: "网关错误。",
  503: "服务不可用，服务器暂时过载或维护。",
  504: "网关超时。",
};

/** 异常处理程序
 * @see https://beta-pro.ant.design/docs/request-cn
 */
const errorHandler = (error: ResponseError) => {
  const { response } = error;
  if (response && response.status) {
    const errorText = codeMessage[response.status] || response.statusText;
    const { status, url } = response;

    notification.error({
      message: `请求错误 ${status}: ${url}`,
      description: errorText,
    });
  }

  if (!response) {
    notification.error({
      description: "您的网络发生异常，无法连接服务器",
      message: "网络异常",
    });
  }

  throw response;
};

// request拦截器, 处理token
const tokenInterceptor = (url: string, options: RequestOptionsInit) => {
  const { headers: optionsHeaders, ...otherOptions } = options;

  const headers: any = {
    "Content-Type": "application/json;charset=utf-8",
    ...optionsHeaders,
  };
  if (!headers["Content-Type"]) delete headers["Content-Type"]; // for上传导入

  // step1: auth 处理
  const accessToken = localStorage.getItem("access_token");
  if (accessToken) headers.Authorization = accessToken;

  if (url.startsWith("/mock")) {
    url = `https://mockapi.eolinker.com/IMGnHVIb11310282d113f38f7d59566e0d4265e990e572e${url}`;
  } else if (url.indexOf("geocode") === -1) {
    url = `/api${url}`;
  }

  return {
    url,
    options: {
      ...otherOptions,
      headers,
    },
  };
};

// request拦截器, 处理 401
const resInterceptor = async (
  response: Response,
  options: RequestOptionsInit
) => {
  if (options.responseType === "blob") {
    const disposition = response.headers.get("Content-Disposition");
    return {
      ...response,
      content: await response.blob(), // 将二进制的数据转为blob对象，这一步是异步的因此使用async/await
      fileName: disposition
        ? decodeURI(escape(disposition.split(";")[1].split("filename=")[1]))
        : "", // 处理Content-Disposition，获取header中的文件名
    };
  }

  const data = await response.clone().json();
  const isSqlError =
    (data.msg || "").indexOf("java.sql.SQLSyntaxErrorException") !== -1;
  // @ts-ignore
  const hideError = options.params?.hideError;

  switch (data.code) {
    case 401:
    case 403:
      notification.warning({
        message: "登录信息过期,请重新登陆!",
        duration: 3,
      });
      localStorage.clear();
      history.replace(PageEnum.BASE_LOGIN);
      break;
    case 1:
      data.code = 200;
      break;
    case 0:
    case 500:
      if (!isSqlError && !hideError) message.error(data.msg || "服务器错误！");
      break;
    default:
  }

  return data;
};

// https://umijs.org/zh-CN/plugins/plugin-request
export const request: RequestConfig = {
  errorHandler,
  timeout: 20000,
  requestInterceptors: [tokenInterceptor],
  responseInterceptors: [resInterceptor],
};
```

### routes.ts

```ts
export default [
  {
    path: "/sys",
    layout: false,
    routes: [
      {
        path: "/sys",
        routes: [
          { name: "登录", path: "/sys/login", component: "./user/Login" },
        ],
      },
      { component: "./404" },
    ],
  },

  {
    path: "/welcome",
    name: "欢迎",
    icon: "smile",
    component: "./other/Welcome",
  },

  {
    path: "/head",
    name: "总部",
    icon: "crown",
    routes: [
      {
        path: "/head/basic",
        name: "门店管理",
        icon: "smile",
        routes: [
          {
            path: "/head/basic/hotel",
            name: "门店基础信息",
            exact: true,
            component: "./head/basic/Hotel",
          },
          {
            path: "/head/basic/hotel-form",
            name: "门店信息表单",
            exact: true,
            hiddenInMenu: true,
            component: "./head/basic/Hotel/HotelForm",
          },
          {
            path: "/head/basic/roomtype",
            name: "门店房型信息",
            exact: true,
            component: "./head/basic/RoomType",
          },
          {
            path: "/head/basic/room",
            name: "门店房间信息",
            exact: true,
            component: "./head/basic/Room",
          },
          {
            component: "./404",
          },
        ],
      },

      {
        path: "/head/brand",
        name: "品牌及产品管理",
        icon: "crown",
        routes: [
          {
            path: "/head/brand/roomtype",
            name: "品牌房型管理",
            exact: true,
            component: "./head/brand/RoomType",
          },
          {
            path: "/head/brand/info",
            name: "品牌基础信息管理",
            exact: true,
            component: "./head/brand/Brand",
          },
          {
            component: "./404",
          },
        ],
      },

      {
        path: "/head/channel",
        name: "渠道管理",
        icon: "control",
        routes: [
          {
            path: "/head/channel/room-pricecode",
            name: "房型价码配置",
            exact: true,
            component: "./head/channel/RoomPriceCode",
          },
          {
            path: "/head/channel/config-channel",
            name: "门店直连配置",
            exact: true,
            component: "./head/channel/ConfigChannel",
          },
          {
            path: "/head/channel/shop-price",
            name: "门店价格配置",
            exact: true,
            component: "./head/channel/ShopPrice",
          },
          {
            path: "/head/channel/enterprise",
            name: "协议客户管理",
            exact: true,
            component: "./head/channel/Enterprise",
          },
          {
            component: "./404",
          },
        ],
      },

      {
        path: "/head/order",
        name: "订单管理",
        icon: "send",
        component: "./head/order",
      },
      {
        path: "/head/invoicing",
        name: "发票管理",
        icon: "control",
        component: "./head/invoicing",
      },
      {
        path: "/head/room-service",
        name: "客房服务",
        icon: "control",
        component: "./head/RoomService",
      },
      {
        component: "./404",
      },
    ],
  },

  {
    path: "/hotel",
    name: "门店",
    icon: "send",
    routes: [
      {
        path: "/hotel/roomstate",
        name: "房态信息",
        exact: true,
        component: "./hotel/RoomState",
      },
      {
        path: "/hotel/invoicing",
        name: "开票管理",
        exact: true,
        component: "./hotel/Invoicing",
      },
      {
        path: "/hotel/workbill",
        name: "工作账管理",
        exact: true,
        component: "./hotel/WorkBill",
      },
      {
        path: "/hotel/teamorder",
        name: "团队订单管理",
        exact: true,
        component: "./hotel/TeamOrder",
      },
      {
        path: "/hotel/order",
        name: "订单管理",
        exact: true,
        component: "./hotel/Order",
      },
      {
        component: "./404",
      },
    ],
  },

  {
    path: "/system",
    name: "系统管理",
    icon: "setting",
    routes: [
      {
        path: "/system/account",
        name: "账号管理",
        exact: true,
        component: "./system/Account",
      },
      {
        path: "/system/role",
        name: "角色管理",
        exact: true,
        component: "./system/Role",
      },
      {
        path: "/system/menu",
        name: "菜单管理",
        exact: true,
        component: "./system/Menu",
      },
      {
        path: "/system/dept",
        name: "部门管理",
        exact: true,
        component: "./system/Dept",
      },
      {
        path: "/system/post",
        name: "岗位管理",
        exact: true,
        component: "./system/Post",
      },
      {
        path: "/system/dict",
        name: "字典管理",
        exact: true,
        component: "./system/Dict",
      },
      {
        path: "/system/dict/:dictId",
        name: "字典数据",
        exact: true,
        hideInMenu: true,
        component: "./system/Dict/Data",
      },
      {
        path: "/system/job",
        name: "任务管理",
        exact: true,
        component: "./system/Job",
      },
      {
        path: "/system/joblog",
        name: "调度日志",
        hideInMenu: true,
        exact: true,
        component: "./system/Job/Log",
      },
      {
        path: "/system/apilogs",
        name: "接口管理",
        exact: true,
        component: "./system/ApiLogs",
      },
      {
        path: "/system/appversion",
        name: "APP版本管理",
        exact: true,
        component: "./system/AppVersion",
      },
      {
        path: "/system/search",
        name: "搜索管理",
        icon: "smile",
        routes: [
          {
            path: "/system/search/search-words",
            name: "搜索词管理",
            exact: true,
            component: "./system/search/SearchWords",
          },
        ],
      },
    ],
  },

  {
    path: "/",
    redirect: "/welcome",
  },
  {
    component: "./404",
  },
];
```
